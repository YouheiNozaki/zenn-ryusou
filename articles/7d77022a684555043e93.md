---
title: "モダンJavaScriptへの第一歩 ~「TwitterAPIのデータをCSVに出力する」反省編~"
emoji: "😽"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["JavaScript"]
published: false
---

以前[TwitterAPI](https://zenn.dev/ryusou/articles/twitterapi-writecsv)に関する記事を書かせていただきました。
今回はそのコードで指摘を受けた問題点などをもとに、JavaScriptを書く際に心がけることについて考えていこうと思います。

上記の記事は以下のようなコードです。

```javascript

// 一部抜粋
const data = []

async function searchTweet(count) {
  await client.get('search/tweets', {
    q: `キャンペーン フォロー min_faves:30 min_retweets:100 (filter:images OR filter:link)`,
    count: count,
    tweet_mode: 'extended'
  }, (error, searchData) => {
    if(error) {
      console.log("キャンペーンの一覧取得に失敗しました。")
      console.error(error)
      return error
    }
   searchData.statuses.forEach(tweet => {
      data.push({
        id: tweet.id,
        name: tweet.user.name,
        screen_name: tweet.user.screen_name,
        image_url: tweet.user.profile_image_url,
        created_at: tweet.created_at,
        text: tweet.full_text.replace(/\r?\n/g, ""),
        favorite_count: tweet.favorite_count,
        retweet_count: tweet.retweet_count
      })
    })
    // CSVに出力
    csvWriter
      .writeRecords(data)
      .then(()=> console.log('The CSV file was written successfully'))
    },
  );
}


searchTweet(100)
```

上記のコードの問題点はなんでしょうか？ぜひ、考えてみてください。
色々突っ込みどころがありそうですが、一部書き換えた中で感じた自分の解釈を今回は述べていこうと思います。

# 1.グローバル空間にdataという汎用的な変数を定義してしまっている。
まず`const data = []`というようなコードをsearchTweetの外で定義しています。この関数がサービスでモジュールとして使用することを考えるとこのようなdataという汎用的な変数をグローバル空間に宣言するべきではありません。
変数名が衝突したり、意図せずに配列操作がされてしまう恐れがあります。
不要な変数を定義しないように心がける必要がありそうです。

# 2.破壊的メソッドでの配列操作
1にも関わる話ですが、いわゆる破壊的なメソッドで配列操作を行うことは避けるべきです。
参考:https://jsprimer.net/basic/array/#mutable-immutable

data.pushは元の配列の値の要素を追加して、上書きするメソッドです。
破壊的メソッドの使用はさけ、immutable(非破壊的)なコードを書くように心がける必要があります。
ここでは配列操作に`map`メソッドを使用するのが良いでしょう。
1.2を合わせると以下のようなコードになります。

```javascript
const data = searchData.statuses.map(tweet => {
  return {
    id: tweet.id,
    name: tweet.user.name,
    screen_name: tweet.user.screen_name,
    image_url: tweet.user.profile_image_url,
    created_at: tweet.created_at,
    text: tweet.full_text.replace(/\r?\n/g, ""),
    favorite_count: tweet.favorite_count,
    retweet_count: tweet.retweet_count
  }
})
```
